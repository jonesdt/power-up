---
#If a firewall is enabled, the following default ports must be granted access on all management hosts for IBM Spectrum Conductor Deep Learning Impact: 9243, 9280, 5000, 5001, 27017, and 6379. If you change these ports after installation, make sure to update firewall rules accordingly.
#

- name: Include vars of envs_spectrum_conductor_dli_template.yml into the 'ports' variable
  include_vars:
    file: envs_spectrum_conductor_dli_template.yml
    name: ports

- name: DEBUG - List imported Variables
  debug:
    msg: "{{ ports }}"

- name: List all host firewall data
  shell: "firewall-cmd --list-all"
  delegate_to: localhost
  register: host_firewall_status
  become: yes

- name: Checking firewall_status stdout
  debug:
    msg: "{{ host_firewall_status.stdout }}"

- name: Checking firewall_status for http service enabled
  debug:
    msg: "{{ host_firewall_status.stdout.find('http') }}"

- name: Print success status of Host firewall
  command: echo "Firewall Exists"
  when: host_firewall_status.stdout.find('http') != -1

- name: Else print fail status
  command: echo "WARNING - Firewall Not Enabled"
  when: host_firewall_status.stdout.find('http') == -1

- name: Open Ports for Spectrum Conductor - If firewall is enabled
  firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  with_items:
     - "{{ ports.DLI_DLPD_REST_PORT }}/tcp"
     - "{{ ports.DLI_DLPD_REST_PORT_SSL_NOT_ENABLED }}/tcp"
     - "{{ ports.DLI_INSIGHTS_MONITOR_PORT }}/tcp"
     - "{{ ports.DLI_INSIGHTS_OPTIMIZER_PORT }}/tcp"
     - "{{ ports.DLI_MONGODB_PORT }}/tcp"
     - "{{ ports.DLI_REDIS_PORT }}/tcp"
  when: host_firewall_status.stdout.find('http') != -1
  become: yes
  register: port_status

- name: Debug - Open Ports for Spectrum Conductor
  debug:
    msg: "{{ port_status }}"
